#!/usr/bin/env bash

echo `date` > $MASTER_SYNC_LOCK_FILE
echo ">>> Rewinding to the latest state"

TRY_TO_FOLLOW_CLUSTER_MASTER=`PGCONNECT_TIMEOUT=$CHECK_PGCONNECT_TIMEOUT PGPASSWORD=$REPLICATION_PASSWORD  psql -h $CURRENT_REPLICATION_PRIMARY_HOST -U $REPLICATION_USER -p $REPLICATION_PRIMARY_PORT $REPLICATION_DB -tAc "SELECT count(*) FROM $(get_repmgr_schema).$REPMGR_NODES_TABLE WHERE (type='primary' OR type='master') AND conninfo LIKE '%host=$CURRENT_REPLICATION_PRIMARY_HOST%'"`

if [[ "$MASTER_SLAVE_SWITCH" == "1" ]] || [ "$TRY_TO_FOLLOW_CLUSTER_MASTER" == "1" ]; then
    echo ">>>>>> Start server to be able to rewind (weird hack to avoid dirty shutdown issue)"
    rm -rf $PGDATA/pg_xlog/archive_status/
    rm $PGDATA/postmaster.pid
    gosu postgres pg_ctl -D "$PGDATA"  -o "-c listen_addresses='localhost'" -w start 

    echo ">>>>>> Removing unactive replication slots of partners"
    close_partners_slots
    
    echo ">>>>>> Stop server"
    gosu postgres pg_ctl stop

    echo ">>>>>> Creating replication slot for the standby in case it's not there"
    REPLICATION_SLOT=`cat $PGDATA/recovery.conf | grep primary_slot_name | awk -F" = " '{print $2}'`
    if [ "$REPLICATION_SLOT" != "" ]; then
        echo ">>>>>>>>> Creating $REPLICATION_SLOT"
        PGCONNECT_TIMEOUT=$CHECK_PGCONNECT_TIMEOUT PGPASSWORD=$REPLICATION_PASSWORD  psql -h $CURRENT_REPLICATION_PRIMARY_HOST -U $REPLICATION_USER -p $REPLICATION_PRIMARY_PORT $REPLICATION_DB -c "SELECT * FROM pg_create_physical_replication_slot('$REPLICATION_SLOT')"
    fi
    echo ">>>>>> Rewind to the host $CURRENT_REPLICATION_PRIMARY_HOST"
    gosu postgres pg_rewind --source-server="user=$REPLICATION_USER password=$REPLICATION_PASSWORD host=$CURRENT_REPLICATION_PRIMARY_HOST dbname=$REPLICATION_DB  port=$REPLICATION_PRIMARY_PORT connect_timeout=10" --target-pgdata=$PGDATA
    
    echo ">>>>>> Restoring configs"

    gosu postgres echo "standby_mode = 'on'
primary_conninfo = 'user=$REPLICATION_USER password=$REPLICATION_PASSWORD connect_timeout=2 host=$CURRENT_REPLICATION_PRIMARY_HOST port=$REPLICATION_PRIMARY_PORT application_name=$NODE_NAME'
recovery_target_timeline = 'latest'
primary_slot_name = $(get_node_slot_name)" > $PGDATA/recovery.conf
fi


if [ "$TRY_TO_FOLLOW_CLUSTER_MASTER" == "0" ]; then
    echo ">>>>>> Repmgr can follow only main cluster master"
else
    open_slot_on_upstream
    echo ">>>>>> Start server"
    gosu postgres pg_ctl -D "$PGDATA" -w start && wait_local_postgres
    
    echo ">>>>>> Tell repmgr to follow upstream($CURRENT_REPLICATION_PRIMARY_HOST) for the node"
    standby_reregister
    gosu postgres repmgr -h $CURRENT_REPLICATION_PRIMARY_HOST -p $REPLICATION_PRIMARY_PORT -d $REPLICATION_DB -U $REPLICATION_USER -D $PGDATA standby follow -W --log-level DEBUG --verbose

    echo ">>>>>> Stop server"
    gosu postgres pg_ctl stop
fi

rm -rf $MASTER_SYNC_LOCK_FILE
